<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>상품 찾기</title>
    <style>
      body {
        font-family: ui-sans-serif, system-ui, -apple-system;
        margin: 0;
        background: #0b1020;
        color: #e7ecff;
      }
      a {
        color: #9db4ff;
        text-decoration: none;
      }
      .wrap {
        max-width: 980px;
        margin: 0 auto;
        padding: 24px;
      }
      .card {
        background: #121a33;
        border: 1px solid #24305e;
        border-radius: 14px;
        padding: 16px;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .row3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
      }
      label {
        display: block;
        font-size: 12px;
        color: #a9b6e6;
        margin-bottom: 6px;
      }
      select,
      input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #2a3769;
        background: #0f1630;
        color: #e7ecff;
      }
      button {
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid #2f3c73;
        background: #1b2a57;
        color: #e7ecff;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        margin-bottom: 14px;
      }
      .muted {
        color: #9aa7d8;
        font-size: 13px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
        margin-top: 14px;
      }
      .p {
        background: #0f1630;
        border: 1px solid #263465;
        border-radius: 14px;
        padding: 12px;
      }
      .p h3 {
        margin: 0 0 8px;
        font-size: 14px;
        line-height: 1.3;
      }
      .p .meta {
        font-size: 12px;
        color: #9aa7d8;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .pill {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 999px;
        background: #182554;
        border: 1px solid #2a3769;
      }
      .status {
        margin-top: 10px;
        font-size: 13px;
        color: #b8c5ff;
      }
      @media (max-width: 760px) {
        .row,
        .row3,
        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="top">
        <div>
          <div style="font-size: 18px; font-weight: 700">상품 찾기</div>
          <div class="muted">카테고리/수량 입력 → 잡 생성 → 결과 표시</div>
        </div>
        <div class="muted"><a href="/history">히스토리 보기</a></div>
      </div>

      <div class="card">
        <div class="row">
          <div>
            <label>상위 카테고리</label>
            <select id="category"></select>
          </div>
          <div>
            <label>하위 카테고리</label>
            <select id="subcategory"></select>
          </div>
        </div>

        <div class="row3" style="margin-top: 12px">
          <div>
            <label>수량(상품 개수)</label>
            <input id="count" type="number" min="1" max="200" value="10" />
          </div>
          <div>
            <label>과거 상품 제외</label>
            <select id="dedupe">
              <option value="true" selected>예(중복 제거)</option>
              <option value="false">아니오(중복 허용)</option>
            </select>
          </div>
          <div style="display: flex; align-items: end; gap: 10px">
            <button id="run">찾기</button>
            <button id="stop" disabled>중지</button>
          </div>
        </div>

        <div id="status" class="status"></div>
      </div>

      <div id="results" class="grid"></div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      let pollTimer = null;
      let currentJobId = null;
      let abort = false;

      function esc(s) {
        return String(s ?? "").replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            }[c])
        );
      }

      async function loadCategories() {
        const res = await fetch("/v1/categories");
        const data = await res.json();
        const cats = data.categories || {};
        const catSel = $("category");
        catSel.innerHTML = "";
        Object.keys(cats).forEach((k) => {
          const opt = document.createElement("option");
          opt.value = k;
          opt.textContent = k;
          catSel.appendChild(opt);
        });
        catSel.value = Object.keys(cats)[0] || "";
        function refreshSubs() {
          const c = catSel.value;
          const subs =
            cats[c] && cats[c].subcategories ? cats[c].subcategories : {};
          const subSel = $("subcategory");
          subSel.innerHTML = "";
          const keys = Object.keys(subs);
          if (keys.length === 0) {
            const opt = document.createElement("option");
            opt.value = "";
            opt.textContent = "(하위 없음)";
            subSel.appendChild(opt);
            subSel.value = "";
            subSel.disabled = true;
            return;
          }
          subSel.disabled = false;
          keys.forEach((k) => {
            const opt = document.createElement("option");
            opt.value = k;
            opt.textContent = k;
            subSel.appendChild(opt);
          });
          subSel.value = keys[0] || "";
        }
        catSel.addEventListener("change", refreshSubs);
        refreshSubs();
      }

      function renderProducts(products) {
        const root = $("results");
        root.innerHTML = "";
        (products || []).forEach((p) => {
          const sno = p.sno;
          const name = p.name || "(no name)";
          const market = p.market_name || "";
          const url = p.url || "";
          const category = p.category || "";
          const cover =
            p.cover_images && p.cover_images[0] ? p.cover_images[0] : null;
          const detailCount = (p.detail_images || []).length;
          const sell =
            p.sell_count != null ? Number(p.sell_count).toLocaleString() : "";
          const review =
            p.review_count != null
              ? Number(p.review_count).toLocaleString()
              : "";
          const pos =
            p.positive_percent != null ? `${p.positive_percent}%` : "";

          const el = document.createElement("div");
          el.className = "p";
          el.innerHTML = `
            <div class="meta" style="margin-bottom:8px;">
              <span class="pill">#${esc(sno)}</span>
              ${category ? `<span class="pill">${esc(category)}</span>` : ``}
              ${market ? `<span class="pill">${esc(market)}</span>` : ``}
            </div>
            <h3>${esc(name)}</h3>
            <div class="meta">
              ${sell ? `<span>구매 ${esc(sell)}</span>` : ``}
              ${review ? `<span>리뷰 ${esc(review)}</span>` : ``}
              ${pos ? `<span>긍정 ${esc(pos)}</span>` : ``}
              <span>상세 이미지 ${detailCount}개</span>
            </div>
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
              ${
                url
                  ? `<a href="${esc(
                      url
                    )}" target="_blank" rel="noreferrer">상품 페이지</a>`
                  : ``
              }
              ${
                cover
                  ? `<a href="${esc(
                      cover
                    )}" target="_blank" rel="noreferrer">썸네일(링크)</a>`
                  : ``
              }
            </div>
          `;
          root.appendChild(el);
        });
      }

      async function pollJob(jobId) {
        while (!abort) {
          const res = await fetch(`/v1/jobs/${jobId}`);
          const job = await res.json();
          $("status").textContent = `job=${jobId} status=${job.status}`;
          if (job.status === "failed")
            throw new Error(job.error || "job failed");
          if (job.status === "succeeded") return;
          await new Promise((r) => setTimeout(r, 1200));
        }
      }

      async function run() {
        abort = false;
        $("run").disabled = true;
        $("stop").disabled = false;
        $("results").innerHTML = "";
        $("status").textContent = "잡 생성 중...";

        const category = $("category").value || null;
        const subcategory = $("subcategory").disabled
          ? null
          : $("subcategory").value || null;
        const count = Number($("count").value || "10");
        const dedupe = $("dedupe").value === "true";

        // UX: 이 서비스는 “원하는 수량만큼”을 위해 하위 카테고리 선택을 권장
        if (!subcategory && !$("subcategory").disabled) {
          $("status").textContent =
            "하위 카테고리를 선택해 주세요(원하는 수량만큼 정확히 찾기 위해).";
          $("run").disabled = false;
          $("stop").disabled = true;
          return;
        }

        const body = {
          all: false,
          category,
          subcategory,
          max_products_per_target: Math.max(1, Math.min(200, count)),
          dedupe_against_history: dedupe,
          include_cover_image_urls: true,
          include_detail_image_urls: true,
        };

        const res = await fetch("/v1/jobs", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify(body),
        });
        const created = await res.json();
        currentJobId = created.job_id;
        $("status").textContent = `job=${currentJobId} 생성됨. 실행 중...`;

        await pollJob(currentJobId);

        const prodRes = await fetch(`/v1/jobs/${currentJobId}/products`);
        const data = await prodRes.json();
        $("status").textContent = `완료: ${data.count}개`;
        renderProducts(data.products);
      }

      $("run").addEventListener("click", () =>
        run()
          .catch((e) => {
            $("status").textContent = `에러: ${e.message || e}`;
          })
          .finally(() => {
            $("run").disabled = false;
            $("stop").disabled = true;
          })
      );

      $("stop").addEventListener("click", () => {
        abort = true;
        $("status").textContent = "중지 요청됨(다음 폴링부터 중단).";
        $("run").disabled = false;
        $("stop").disabled = true;
      });

      loadCategories().catch((e) => {
        $("status").textContent = `카테고리 로드 실패: ${e.message || e}`;
      });
    </script>
  </body>
</html>
